---
title: Shader ä»‹ç»
---

`ShaderLab` æ˜¯ Galacean é’ˆå¯¹ Shader è‡ªä¸»ç ”å‘çš„ä¸€å¥—æè¿°è¯­è¨€ï¼Œå®ƒæä¾›äº†ä¸€å¥—å®Œæ•´çš„è¯­æ³•æ¥å®šä¹‰ç€è‰²å™¨çš„ç»“æ„ã€å±æ€§ã€æ¸²æŸ“çŠ¶æ€å’Œç€è‰²å™¨ä»£ç ã€‚é€šè¿‡ ShaderLabï¼Œå¼€å‘è€…å¯ä»¥åˆ›å»ºä»ç®€å•åˆ°å¤æ‚çš„å„ç§è§†è§‰æ•ˆæœã€‚

## ä»€ä¹ˆæ˜¯ ShaderLab

`ShaderLab` æ˜¯ä¸€ç§å£°æ˜å¼çš„ç€è‰²å™¨æè¿°è¯­è¨€ï¼Œå®ƒå°†ç€è‰²å™¨çš„å„ä¸ªç»„æˆéƒ¨åˆ†ç»„ç»‡æˆæ¨¡å—åŒ–çš„ç»“æ„ã€‚ä¸ä¼ ç»Ÿçš„ GLSL/HLSL ä¸åŒï¼ŒShaderLab ä¸ä»…åŒ…å«ç€è‰²å™¨ä»£ç ï¼Œè¿˜åŒ…å«æè´¨å±æ€§å®šä¹‰ã€UIç•Œé¢é…ç½®ã€æ¸²æŸ“çŠ¶æ€è®¾ç½®ç­‰å®Œæ•´ä¿¡æ¯ã€‚

### è§£å†³çš„é—®é¢˜

`ShaderLab` æ¡†æ¶ä¸»è¦è§£å†³ä»¥ä¸‹ä¼ ç»Ÿç€è‰²å™¨å¼€å‘ä¸­çš„ç—›ç‚¹ï¼š

- **ä»£ç é‡å¤**ï¼šVS å’Œ FS ç¼–å†™éœ€è¦ä¸¤ä¸ªæ–‡ä»¶ï¼Œvarying éœ€è¦å£°æ˜ä¸¤éï¼Œuniform ä¹Ÿéœ€è¦å£°æ˜ä¸¤é
- **è„šæœ¬æ‹¼è£…**ï¼šå¤š SubShader å’Œå¤š Pass éœ€è¦è„šæœ¬æ‹¼è£…é—®é¢˜
- **çŠ¶æ€åˆ†ç¦»**ï¼šShader ä¸­æ— æ³•è®¾ç½® RenderState çŠ¶æ€ï¼Œéœ€è¦å›åˆ°è„šæœ¬ä¸­å»ä¿®æ”¹
- **æ ‡ç­¾ç®¡ç†**ï¼šTags éœ€è¦é€šè¿‡è„šæœ¬ç»„è£…
- **ä»£ç æ··ä¹±**ï¼šattributeã€uniformã€varying ä¹¦å†™æ··ä¹±ï¼Œäº’ç›¸ç©¿æ’
- **å±æ€§åå°„**ï¼šç¼–è¾‘å™¨ä¸­ Shader å±æ€§çš„åå°„å›°éš¾

### æ ¸å¿ƒç‰¹æ€§

- **ğŸ¯ æ¨¡å—åŒ–è®¾è®¡**ï¼šå°†ç€è‰²å™¨åˆ†è§£ä¸ºç‹¬ç«‹çš„åŠŸèƒ½æ¨¡å—
- **ğŸ¨ å¯è§†åŒ–ç¼–è¾‘**ï¼šè‡ªåŠ¨ç”Ÿæˆæè´¨å±æ€§é¢æ¿
- **ğŸ”„ æ™ºèƒ½äº¤äº’**ï¼šé€šè¿‡ UIScript å®ç°å±æ€§è”åŠ¨
- **âš¡ é«˜æ€§èƒ½**ï¼šç¼–è¯‘æ—¶ä¼˜åŒ–å’Œè¿è¡Œæ—¶é«˜æ•ˆæ‰§è¡Œ
- **ğŸŒ è·¨å¹³å°**ï¼šè‡ªåŠ¨é€‚é…ä¸åŒå›¾å½¢ API

## ShaderLab ç»“æ„

```glsl showLineNumbers {3-4, 16, 21, 24, 39, 49, 51, 54, 56, 58, 66, 69, 73, 77-78, 80, 90 }
Shader "Custom/MyShader" {
    // -------------------- ç¼–è¾‘å™¨é…ç½®åŒº --------------------
    Editor {
        Properties {
            material_BaseColor("åŸºç¡€é¢œè‰²", Color) = (1, 1, 1, 1);
            material_BaseTexture("åŸºç¡€çº¹ç†", Texture2D);
            material_Metallic("é‡‘å±åº¦", Range(0, 1, 0.01)) = 0.0;
            material_Roughness("ç²—ç³™åº¦", Range(0, 1, 0.01)) = 1.0;
            
            Header("é«˜çº§é€‰é¡¹") {
                material_EmissiveColor("è‡ªå‘å…‰", Color) = (0, 0, 0, 1);
                material_NormalTexture("æ³•çº¿è´´å›¾", Texture2D);
            }
        }
        
        Macros {
            [Off] HAS_VERTEX_COLOR("é¡¶ç‚¹é¢œè‰²");
            [On] ENABLE_NORMAL_MAP("æ³•çº¿è´´å›¾", Boolean) = false;
        }
        
        UIScript "path/to/script.ts";
    }
    
    // -------------------- å…¨å±€å˜é‡å£°æ˜åŒº --------------------
    struct Attributes {
        vec3 POSITION;
        vec2 TEXCOORD_0;
    };
    
    struct Varyings {
        vec2 uv;
    };
    
    // å£°æ˜å…¨å±€æè´¨å±æ€§
    vec4 material_BaseColor;
    sampler2D material_BaseTexture;
    mat4 renderer_MVPMat;
    
    // å£°æ˜å…¨å±€æ¸²æŸ“çŠ¶æ€
    BlendState customBlendState {
        Enabled = true;
        SourceColorBlendFactor = BlendFactor.SourceAlpha;
        DestinationColorBlendFactor = BlendFactor.OneMinusSourceAlpha;
        SourceAlphaBlendFactor = BlendFactor.One;
        DestinationAlphaBlendFactor = BlendFactor.OneMinusSourceAlpha;
    };

    // -------------------- SubShader å®šä¹‰åŒº --------------------
    SubShader "Default" {
        // å¼•å…¥é˜´å½±æŠ•å°„ Pass
        UsePass "pbr/Default/ShadowCaster"

        // è‡ªå®šä¹‰ Pass
        Pass "Forward Pass" {
            // æŒ‡å®š Shader Tag, ç®¡çº¿æ ¹æ®ä¸åŒé…ç½®è°ƒç”¨
            Tags { "pipelineStage" = "Forward" }
              
            // å£°æ˜å±€éƒ¨æ¸²æŸ“çŠ¶æ€
            DepthState customDepthState {
                Enabled = true;
                WriteEnabled = true;
                CompareFunction = CompareFunction.LessEqual;
            }

            // ä½¿ç”¨å…¨å±€æ¸²æŸ“çŠ¶æ€
            BlendState = customBlendState;
          
            // ä½¿ç”¨å±€éƒ¨æ¸²æŸ“çŠ¶æ€
            DepthState = customDepthState;
          

            // ä»£ç æ®µå¼•ç”¨
            #include "Common.glsl"
                

            // æŒ‡å®š é¡¶ç‚¹ã€ç‰‡å…ƒ å…¥å£
            VertexShader = PBRVertex;
            FragmentShader = PBRFragment;

            // é¡¶ç‚¹ç€è‰²å™¨ä»£ç ç¼–å†™
            Varyings vert(Attributes input) {
                Varyings output;
                
                output.uv = input.TEXCOORD_0;
                
                gl_Position = renderer_MVPMat * vec4(input.POSITION, 1.0);
                return output;
            }

            // ç‰‡å…ƒç€è‰²å™¨ä»£ç ç¼–å†™
            void frag(Varyings input) {
                vec4 baseColor = material_BaseColor;
                
                #ifdef MATERIAL_HAS_BASETEXTURE
                    baseColor *= texture2D(material_BaseTexture, input.uv);
                #endif
                
                gl_FragColor = baseColor;
            }
        }
    }
}
```

## è¯­æ³•æ¨¡å—

### 1. Shader æ¨¡å—

Shader æ¨¡å—æ˜¯ ShaderLab çš„æ ¹æ¨¡å—ï¼Œå®šä¹‰ç€è‰²å™¨çš„åŸºæœ¬ä¿¡æ¯å’Œå…¨å±€è®¾ç½®ï¼š

```glsl showLineNumbers {1-8}
Shader "Custom/MyShader" {
    // å…¨å±€å˜é‡å£°æ˜
    // Editor é…ç½®
    // SubShader å®šä¹‰
}
```

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- å®šä¹‰ç€è‰²å™¨åç§°å’Œå‘½åç©ºé—´
- å£°æ˜å…¨å±€å˜é‡å’Œç»“æ„ä½“
- åŒ…å«ç¼–è¾‘å™¨é…ç½®å’Œå­ç€è‰²å™¨

### 2. Editor æ¨¡å—

Editor æ¨¡å—å®šä¹‰æè´¨å±æ€§é¢æ¿å’Œäº¤äº’é€»è¾‘ï¼š

<div style={{display: "flex"}}>

  <Image src="https://mdn.alipayobjects.com/huamei_aftkdx/afts/img/A*mwAxRr45kE8AAAAAAAAAAAAAeteEAQ/fmt.webp" width="435px" />

  <Image src= "https://mdn.alipayobjects.com/huamei_aftkdx/afts/img/A*7MrxTIG5fpkAAAAAAAAAAAAAeteEAQ/fmt.webp" width="200px" />

</div>


**æ”¯æŒçš„å±æ€§ç±»å‹ï¼š**

| ç±»å‹ | è¯­æ³•ç¤ºä¾‹ | æè¿° |
|------|----------|------|
| `Boolean` | `property("æè¿°", Boolean) = true` | å¸ƒå°”å¼€å…³ |
| `Int` | `property("æè¿°", Int) = 1` | æ•´æ•° |
| `Float` | `property("æè¿°", Float) = 0.5` | æµ®ç‚¹æ•° |
| `Range` | `property("æè¿°", Range(0, 1, 0.01)) = 0.5` | èŒƒå›´æ»‘å— |
| `Color` | `property("æè¿°", Color) = (1, 1, 1, 1)` | é¢œè‰²é€‰æ‹©å™¨ |
| `Vector2/3/4` | `property("æè¿°", Vector4) = (1, 1, 1, 1)` | å‘é‡è¾“å…¥ |
| `Texture2D` | `property("æè¿°", Texture2D)` | 2Dçº¹ç† |
| `TextureCube` | `property("æè¿°", TextureCube)` | ç«‹æ–¹ä½“çº¹ç† |
| `Enum` | `property("æè¿°", Enum(A:0, B:1)) = 0` | æšä¸¾é€‰æ‹© |


**æ”¯æŒçš„å®ç±»å‹ï¼š**

å®ä¹Ÿå¯ä»¥åå°„åˆ°ç¼–è¾‘å™¨é¢æ¿ä¸­ï¼Œä»è€Œåœ¨ç¼–è¾‘å™¨ä¸­å¯¹ Shader ä¾èµ–çš„å®è¿›è¡Œçµæ´»çš„è°ƒæ•´ï¼Œå½“ç„¶æˆ‘ä»¬æ›´æ¨èé€šè¿‡ `UIScript` è„šæœ¬ç³»ç»Ÿæ¥å®ç°å®çš„è‡ªåŠ¨åˆ‡æ¢ï¼š

```glsl showLineNumbers
// å¼€å¯/å…³é—­
[On/Off]macroName("MacroLabel", EditType) = [DefaultValue];
```

é€šè¿‡`[On/Off]`æŒ‡ä»¤æŒ‡å®šå®çš„é»˜è®¤å¼€å…³ï¼Œå½“å‰ç¼–è¾‘å™¨æ”¯æŒçš„å®ç±»å‹å¦‚ä¸‹:

|  Type   | Example                                                                                                   |
| :-----: | :-------------------------------------------------------------------------------------------------------- |
| `æ— å€¼å®`  | `macroName("Macro Description");`                                                                           |
|  `Bool`   | `macroName("Macro Description", Boolean) = true;`                                                           |
|  `Int`   |  `macroName("Macro Description", Int) = 1; macroName("Macro Description", Range(0,8)) = 1;`            |
|  `Float`  | `macroName("Macro Description", FLoat) = 0.5; macroName("Macro Description", Range(0.0, 1.0)) = 0.5;` |
|  `Color`  | `macroName("Macro Description", Color) = (0.25, 0.5, 0.5, 1);`                                              |
| `Vector2` | `macroName("Macro Description", Vector2) = (0.25, 0.5);`                                                    |
| `Vector3` | `macroName("Macro Description", Vector3) = (0.25, 0.5, 0.5);`                                               |
| `Vector4` | `macroName("Macro Description", Vector4) = (0.25, 0.5, 0.5, 1.0);`                         


### 3. SubShader æ¨¡å—

SubShader å®šä¹‰æ¸²æŸ“å­ç€è‰²å™¨ï¼Œç›®å‰ä»…æ”¯æŒæŒ‡å®š `replacementTag`, é€šè¿‡å¼•æ“çš„ `camera.setReplacementShader(shader, tagName)` è°ƒç”¨ï¼š

```glsl showLineNumbers
SubShader "SubShaderName" {
    Tags {
        "replacementTag" = "test1";
    }
    
    Pass "PassName" {
        // Pass å†…å®¹
    }
}
```

### 4. Pass æ¨¡å—

Pass å®šä¹‰å…·ä½“çš„æ¸²æŸ“é€šé“ï¼š

```glsl showLineNumbers
Pass "PassName" {
    Tags { "pipelineStage" = "Forward" }
    
    // æ¸²æŸ“çŠ¶æ€
    BlendState customBlendState{
        Enabled = true;
        SourceColorBlendFactor = BlendFactor.SourceAlpha;
        DestinationColorBlendFactor = BlendFactor.OneMinusSourceAlpha;
    }

    // å±€éƒ¨å˜é‡
    vec4 color1;
    
    // æŒ‡å®š é¡¶ç‚¹ã€ç‰‡å…ƒ å…¥å£
    VertexShader = PBRVertex;
    FragmentShader = PBRFragment;
}
```

## æ¸²æŸ“çŠ¶æ€è§„èŒƒ
æ¯ä¸ª `Pass` éƒ½å¯ä»¥è®¾ç½®æ¸²æŸ“çŠ¶æ€ï¼Œæ¯”å¦‚é€æ˜ã€æ·±åº¦å†™å…¥ç­‰ã€‚

### 1. ç±»å‹

æ¸²æŸ“çŠ¶æ€å˜é‡å’Œå¼•æ“æšä¸¾ç±»å‹ä¿æŒä¸€è‡´ï¼Œæ¯”å¦‚ `BlendOperation.Add` å¯¹åº”å¼•æ“çš„ [API](/apis/galacean/#BlendOperation)ã€‚

#### 1.1 BlendState æ··åˆçŠ¶æ€

```glsl showLineNumbers
BlendState {
    Enabled: bool;
    ColorBlendOperation: BlendOperation;
    AlphaBlendOperation: BlendOperation;
    SourceColorBlendFactor: BlendFactor;
    SourceAlphaBlendFactor: BlendFactor;
    DestinationColorBlendFactor: BlendFactor;
    DestinationAlphaBlendFactor: BlendFactor;
    ColorWriteMask: ColorWriteMask;
    BlendColor: Color;
    AlphaToCoverage: bool;
}
```

#### 1.2 DepthState æ·±åº¦çŠ¶æ€

```glsl showLineNumbers
DepthState {
    Enabled: bool;
    WriteEnabled: bool;
    CompareFunction: CompareFunction;
}
```

#### 1.3 StencilState æ¨¡æ¿çŠ¶æ€

```glsl showLineNumbers
StencilState {
    Enabled: bool;
    ReferenceValue: int;
    Mask: float;
    WriteMask: float;
    CompareFunctionFront: CompareFunction;
    CompareFunctionBack: CompareFunction;
    PassOperationFront: StencilOperation;
    PassOperationBack: StencilOperation;
    FailOperationFront: StencilOperation;
    FailOperationBack: StencilOperation;
    ZFailOperationFront: StencilOperation;
    ZFailOperationBack: StencilOperation;
}
```

#### 1.4 RasterState å…‰æ …åŒ–çŠ¶æ€

```glsl showLineNumbers
RasterState {
    CullMode: CullMode;
    FillMode: FillMode;
    DepthBias: float;
    SlopeScaledDepthBias: float;
}
```

### 2. å£°æ˜
æ¸²æŸ“çŠ¶æ€æ”¯æŒ`å¸¸é‡èµ‹å€¼`å’Œ`å˜é‡èµ‹å€¼`ï¼š

```glsl showLineNumbers

// å˜é‡åç§°
RenderQueueType renderQueueType;
BlendFactor destinationColorBlendFactor;
BlendFactor sourceAlphaBlendFactor;
BlendFactor destinationAlphaBlendFactor;

BlendState customBlendState {
    // å¸¸é‡èµ‹å€¼æ–¹å¼
    Enabled = true;
    SourceColorBlendFactor = BlendFactor.SourceColor;

    // å˜é‡èµ‹å€¼æ–¹å¼
    DestinationColorBlendFactor = destinationColorBlendFactor;
    SourceAlphaBlendFactor = sourceAlphaBlendFactor;
    DestinationAlphaBlendFactor = destinationAlphaBlendFactor;
}
```

### 3. ä½¿ç”¨
```glsl showLineNumbers
// ä½¿ç”¨ç»“æ„ä½“
BlendState = customBlendState;

// å˜é‡æ¸²æŸ“é˜Ÿåˆ—
RenderQueueType = renderQueueType;
// å¸¸é‡æ¸²æŸ“é˜Ÿåˆ—
RenderQueueType = Opaque;
RenderQueueType = AlphaTest;
RenderQueueType = Transparent;
```


## å¤šæ¸²æŸ“ç›®æ ‡ï¼ˆMRTï¼‰æ”¯æŒ

```glsl showLineNumbers
struct MRT {
    layout(location = 0) vec4 fragColor0;
    layout(location = 1) vec4 fragColor1;
};

MRT frag(Varyings input) {
    MRT output;
    output.fragColor0 = vec4(1, 0, 0, 1);
    output.fragColor1 = vec4(0, 1, 0, 1);
    return output;
}
```


## å¼•å…¥ä»£ç ç‰‡æ®µ

é€šè¿‡ `#include` æŒ‡ä»¤å¼•å…¥ä»£ç ç‰‡æ®µï¼š

```glsl showLineNumbers
#include "Common.glsl"      // é€šç”¨å‡½æ•°
#include "Light.glsl"       // å…‰ç…§è®¡ç®—
#include "Shadow.glsl"      // é˜´å½±è®¡ç®—
#include "Fog.glsl"         // é›¾æ•ˆè®¡ç®—
#include "./MyCustom.glsl" // è‡ªå®šä¹‰ç‰‡æ®µ
```

## æ³¨å†Œä»£ç ç‰‡æ®µ

å®˜æ–¹æä¾›äº†å¾ˆå¤šå†…ç½®ä»£ç æ®µï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥æ³¨å†Œåä½¿ç”¨:

```ts showLineNumbers {4} filename="Typescript"
import { registerIncludes } from "@galacean/engine-shader";

// å¯¹å†…ç½® ShaderLab ä»£ç æ®µæ³¨å†Œã€‚
registerIncludes();
```

å¦‚æœæ˜¯è‡ªå®šä¹‰çš„ç‰‡æ®µï¼Œå¯ä»¥é€šè¿‡æ¥å£è¿›è¡Œæ‰‹åŠ¨æ³¨å†Œ:
```ts
import { ShaderFactory } from '@galacean/engine';
 
const shaderSource = `{{Your shader code}}`;
ShaderFactory.registerInclude('YourKey', shaderSource);
```


## UIScript è„šæœ¬ç³»ç»Ÿ

`UIScript` æ˜¯ `ShaderLab` çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ï¼Œå…è®¸é€šè¿‡ TypeScript è„šæœ¬å®ç°æ™ºèƒ½çš„å±æ€§é¢æ¿äº¤äº’ï¼ŒåŒ…æ‹¬è®¾ç½®å®å¼€å…³ã€æ¸²æŸ“çŠ¶æ€ç­‰ï¼š

```ts showLineNumbers {}
import { ShaderUIScript, Material } from "@galacean/engine";

export default class MyShaderScript extends ShaderUIScript {
  constructor() {
    super();
    
    // å±æ€§å˜åŒ–ç›‘å¬
    this.onPropertyChanged("material_BaseTexture", this.onBaseTextureChanged);
    this.onPropertyChanged("material_BlendMode", this.onBlendModeChanged);
  }
  
  // ç›‘å¬å±æ€§ï¼Œè®¾ç½®å®å¼€å…³
  private onBaseTextureChanged = (material: Material, value: Texture2D) => {
    if (value) {
      material.shaderData.enableMacro("MATERIAL_HAS_BASETEXTURE");
    } else {
      material.shaderData.disableMacro("MATERIAL_HAS_BASETEXTURE");
    }
  };
  
  // ç›‘å¬å±æ€§ï¼Œè®¾ç½®æ¸²æŸ“çŠ¶æ€
  private onBlendModeChanged = (material: Material, value: BlendMode) => {
    const shaderData = material.shaderData;
    switch (value) {
        case BlendMode.Normal:
          shaderData.setInt("sourceColorBlendFactor", BlendFactor.SourceAlpha);
          shaderData.setInt("destinationColorBlendFactor", BlendFactor.OneMinusSourceAlpha);
          shaderData.setInt("sourceAlphaBlendFactor", BlendFactor.One);
          shaderData.setInt("destinationAlphaBlendFactor", BlendFactor.OneMinusSourceAlpha);
          break;
        case BlendMode.Additive:
          shaderData.setInt("sourceColorBlendFactor", BlendFactor.SourceAlpha);
          shaderData.setInt("destinationColorBlendFactor", BlendFactor.One);
          shaderData.setInt("sourceAlphaBlendFactor", BlendFactor.One);
          shaderData.setInt("destinationAlphaBlendFactor", BlendFactor.OneMinusSourceAlpha);
          break;
      }
  };
}
```

åœ¨ Shader ä¸­ç»‘å®š `UIScript`:

```glsl showLineNumbers {3}
Editor {
    ...
    UIScript "/path/to/script";
    ...
}
```

ç»‘å®šçš„`UIScript`è„šæœ¬è·¯å¾„æ”¯æŒç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„ï¼Œä»¥ä¸‹å›¾é¡¹ç›®æ ¹ç›®å½•ä¸ºä¾‹ï¼Œç»å¯¹è·¯å¾„ä¸º
`/PBRScript1.ts`ï¼Œç›¸å¯¹è·¯å¾„ä¸º`./PBRScript1.ts`

<Image
  src="https://mdn.alipayobjects.com/huamei_aftkdx/afts/img/A*t4LFQ4KEL6kAAAAAAAAAAAAADteEAQ/fmt.webp"
  width="70%"
/>
